{% extends "_base.html" %}

{% block title %}LQFB › Themen › Thema {{data.issue.result.0.id}}{% endblock %}

{% block navigation %}
{{ super() }}
  <ul class="breadcrumb">
    <li><a href="/"><i class="icon-home"></i></a> <span class="divider">/</span></li>
    <li><a href="/themen">Themen</a> <span class="divider">/</span></li>
    <li class="active">Thema {{data.issue.result.0.id}}</li>
  </ul>
{% endblock %}

{% block content %}
    <div class="page-header">
      <h1>
        {% if data.issue.result.0.state == "voting" %}
        <a href="{{config.LQFB_URL}}/vote/list.html?issue_id={{data.issue.result.0.id}}" target="lqfb_window" class="btn btn-warning btn-large pull-right" type="button" style="margin-top: 1.5em;">abstimmen</a>
        {% endif %}
        <i class="{{ helper.enums.issue[data.issue.result.0.state].icon }}{% if helper.enums.issue[data.issue.result.0.state].color %} {{ helper.enums.issue[data.issue.result.0.state].color }}{% endif %} icon-2x pull-left"></i>
        <small>{{ db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.name }}</small><br><i class="icon-list-alt"></i> Thema {{data.issue.result.0.id}}
      </h1>
    </div>

    <div style="width: calc(100% - 4em); width: -moz-calc(100% - 4em); width: -webkit-calc(100% - 4em);">
    <div class="progress" style="background: none; border: none; box-shadow: none; -moz-box-shadow: none; height: 1.5em; line-height: 1.1em;">
      <div class="bar bar-info" style="text-shadow: none; font-size: 1em; box-shadow: none; -moz-box-shadow: none;  background: none; color: #000; width: {{data.issue.result.0.policy_id|policy_time_bars('admission_time')}}%;">
        {% if data.issue.result.0.state == 'admission' %}
        <strong>neu</strong>
        {% else %}
        neu
        {% endif %}
      </div>
      <div class="bar bar-info" style="text-shadow: none; font-size: 1em; box-shadow: none; -moz-box-shadow: none;  background: none; color: #000; width: {{data.issue.result.0.policy_id|policy_time_bars('discussion_time')}}%;">
        {% if data.issue.result.0.state == 'discussion' %}
        <strong>Diskussion</strong>
        {% else %}
        Diskussion
        {% endif %}
      </div>
      <div class="bar bar-info" style="text-shadow: none; font-size: 1em; box-shadow: none; -moz-box-shadow: none;  background: none; color: #000; width: {{data.issue.result.0.policy_id|policy_time_bars('verification_time')}}%;">
        {% if data.issue.result.0.state == 'verification' %}
        <strong>eingefroren</strong>
        {% else %}
        eingefroren
        {% endif %}
      </div>
      <div class="bar bar-info" style="text-shadow: none; font-size: 1em; box-shadow: none; -moz-box-shadow: none;  background: none; color: #000; width: {{data.issue.result.0.policy_id|policy_time_bars('voting_time')}}%;">
        {% if data.issue.result.0.state == 'voting' %}
        <strong>Abstimmung</strong>
        {% else %}
        Abstimmung
        {% endif %}
      </div>
    </div>

    <div class="progress" style="height: 2em; margin-top: -1.5em;">

      <!-- neu -->
      {% if data.issue.result.0.created and not data.issue.result.0.accepted %}
      <div class="bar bar-primary" style="width: {{data.issue.result.0.id|issue_progress * data.issue.result.0.policy_id|policy_time_bars('admission_time') /100 }}%;"></div>
      {% else %}
      <div class="bar bar-primary" style="width: {{data.issue.result.0.policy_id|policy_time_bars('admission_time') }}%;"></div>
      {% endif %}

      <div class="bar bar-border-right"></div>

      <!-- Diskussion -->
      {% if data.issue.result.0.accepted %}
      {% if not data.issue.result.0.half_frozen %}
      <div class="bar bar-primary" style="width: {{data.issue.result.0.id|issue_progress * data.issue.result.0.policy_id|policy_time_bars('discussion_time') /100 }}%;"></div>
      <div class="bar bar-transparent" style="width: {{(100 - data.issue.result.0.id|issue_progress) * data.issue.result.0.policy_id|policy_time_bars('discussion_time') /100 }}%;"></div>
      {% else %}
      <div class="bar bar-primary" style="width: {{data.issue.result.0.policy_id|policy_time_bars('discussion_time') }}%;"></div>
      {% endif %}
      {% endif %}

      <div class="bar bar-border-right"></div>

      <!-- eingefroren -->
      {% if data.issue.result.0.half_frozen %}
      {% if not data.issue.result.0.fully_frozen %}
      <div class="bar bar-info" style="width: {{data.issue.result.0.id|issue_progress * data.issue.result.0.policy_id|policy_time_bars('verification_time') /100.0 }}%;"></div>
      <div class="bar bar-transparent" style="width: {{(100.0 - data.issue.result.0.id|issue_progress) * data.issue.result.0.policy_id|policy_time_bars('verification_time') /100.0 }}%;"></div>
      {% else %}
      <div class="bar bar-info" style="width: {{data.issue.result.0.policy_id|policy_time_bars('verification_time') }}%;"></div>
      {% endif %}
      {% else %}
      <div class="bar bar-transparent" style="width: {{data.issue.result.0.policy_id|policy_time_bars('verification_time') }}%;"></div>
      {% endif %}

      <div class="bar bar-border-right"></div>

      <!-- Abstimmung -->
      {% if data.issue.result.0.fully_frozen %}
      {% if not data.issue.result.0.closed %}
      <div class="bar bar-warning" style="width: {{data.issue.result.0.id|issue_progress * data.issue.result.0.policy_id|policy_time_bars('voting_time') /100.0 }}%;"></div>
      {% else %}
      <div class="bar bar-warning" style="width: {{data.issue.result.0.policy_id|policy_time_bars('voting_time') -0.5 }}%;"></div>
      {% endif %}
      {% else %}
      {% endif %}
    </div>
    
    <span>&nbsp;</span>
    <span style="top: -1em; margin-left: -3em; position: relative; left: {{data.issue.result.0.policy_id|policy_time_bars('admission_time')}}%;">
      {{data.issue.result.0.id|end_of_phase_issue('accepted')|nicedate("%x", timeago=False)}}
    </span>
    <span style="top: -1em; margin-left: -5.4em; position: relative; left: {{data.issue.result.0.policy_id|policy_time_bars('admission_time')+data.issue.result.0.policy_id|policy_time_bars('discussion_time')}}%;">
      {{data.issue.result.0.id|end_of_phase_issue('half_frozen')|nicedate("%x", timeago=False)}}
    </span>
    <span style="top: -1em; margin-left: -5em; position: relative; left: {{data.issue.result.0.policy_id|policy_time_bars('admission_time')+data.issue.result.0.policy_id|policy_time_bars('discussion_time')+data.issue.result.0.policy_id|policy_time_bars('verification_time')}}%;">
      {{data.issue.result.0.id|end_of_phase_issue('fully_frozen')|nicedate("%x", timeago=False)}}
    </span>
    <span style="top: -1em; margin-left: -6em; position: relative; left: {{data.issue.result.0.policy_id|policy_time_bars('admission_time')+data.issue.result.0.policy_id|policy_time_bars('discussion_time')+data.issue.result.0.policy_id|policy_time_bars('verification_time')+data.issue.result.0.policy_id|policy_time_bars('voting_time')}}%;">
      {{data.issue.result.0.id|end_of_phase_issue('closed')|nicedate("%x", timeago=False)}}
    </span>
  </div>

    <h2>Quoren</h2>
    <ul>
      <li>Grundgesamtheit im Bereich {{ data.issue.result.0.area_id|area(True)|safe }}: {{ data.issue.result.0.population }}</li>

      <li>Themen-Quorum im Regelwerk {{ data.issue.result.0.policy_id|policy(True)|safe }}: {{  ((data.policy.result.0.issue_quorum_num / data.policy.result.0.issue_quorum_den)*data.issue.result.0.population)|round(0,'ceil')|int }} ({{ ((data.policy.result.0.issue_quorum_num / data.policy.result.0.issue_quorum_den)*100)|round(1) }}% der Grundgesamtheit)</li>
      
      <li>Initiativen-Quroum im Regelwerk {{ data.issue.result.0.policy_id|policy(True)|safe }}: {{  ((data.policy.result.0.initiative_quorum_num / data.policy.result.0.initiative_quorum_den)*data.issue.result.0.population)|round(0,'ceil')|int }} ({{ ((data.policy.result.0.initiative_quorum_num / data.policy.result.0.initiative_quorum_den)*100)|round(1) }}% der Grundgesamtheit)</li>
      
      {% if data.issue.result.0.voter_count %}
      <li>
        Abstimmungsteilnehmer: {{ data.issue.result.0.voter_count }} ({{ ((data.issue.result.0.voter_count / data.issue.result.0.population)*100) | round(1) }}% der Grundgesamtheit)
      </li>
      {% endif %}
    </ul>

    <h2>Initiativen</h2>

    {% if data.issue.result.0.status_quo_schulze_rank %}

    <h3>Abgestimmt</h3>
    <ol>
      {% for p in data.initiative.result | sort(reverse=False,attribute='rank') %}
      {% if p.admitted %}
      <li><strong>{{ p.id|initiative(True)|safe }}</strong>

        {% if p.winner %}
          <span class="label label-success">Gewinner</span>
        {% else %}
        {% endif %}

        {% if p.eligible %}
        {% else %}
          <span class="label label-important">Mehrheit nicht erreicht</span>
        {% endif %}
        
        {% if p.better_than_status_quo %}
        {% else %}
          <span class="label label-important">nicht besser als Status Quo</span>
        {% endif %}
        
      </li>
      {% endif %}
      {% endfor %}
    </ol>

    <h3>Nicht abgestimmt</h3>
    <ul>
      {% for p in data.initiative.result | sort(reverse=True,attribute='supporter_count') %}
      {% if not p.admitted %}
      <li>
        <strong>{{ p.id|initiative(True)|safe }}</strong>
        {% if p.revoked %}
        <span class="label">zurückgezogen</span>
        {% else %}
        <span class="label">Quroum nicht erreicht</span>
        {% endif %}
      </li>
      {% endif %}
      {% endfor %}
    </ul>

    {% else %}

    {% for p in data.initiative.result | sort(reverse=True,attribute='supporter_count') %}
    <li>
      <strong>{{ p.id|initiative(True)|safe }}</strong>
      {% if p.admitted %}
      <span class="label label-warning">in Abstimmung</span>
      {% else %}
      {% if p.revoked %}
      <span class="label">zurückgezogen</span>
      {% elif data.issue.result.0.state == "voting" %}
      <span class="label">Quroum nicht erreicht</span>
      {% endif %}
      {% endif %}
    </li>
    {% endfor %}

    {% endif %}


    <h2>Historie</h2>
    <ul>
      {% if data.issue.result.0.created %}
      <li>neu: {{ data.issue.result.0.created|nicedate(timeago=False) }}</li>
      {% if not data.issue.result.0.accepted %}
      <li>
        <strong>Spätestes Ende der Phase neu: {{ data.issue.result.0.created|future_date(db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.admission_time)|nicedate(timeago=False) }}
          ({{data.issue.result.0.created|future_date(db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.admission_time)|mynicedate}})</strong>
      </li>
      {% endif %}
      {% endif %}

      {% if data.issue.result.0.accepted %}
      <li>in Diskussion: {{ data.issue.result.0.accepted|nicedate(timeago=False) }}</li>
      {% if not data.issue.result.0.half_frozen %}
      <li>
        <strong>Ende der Diskussion: {{ data.issue.result.0.accepted|future_date(db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.discussion_time)|nicedate(timeago=False) }}
          ({{data.issue.result.0.accepted|future_date(db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.discussion_time)|mynicedate}})</strong>
      </li>
      {% endif %}
      {% endif %}

      {% if data.issue.result.0.half_frozen %}
      <li>eingefroren: {{ data.issue.result.0.half_frozen|nicedate(timeago=False) }}</li>
      {% if not data.issue.result.0.fully_frozen %}
      <li>
        <strong>Ende der Phase: {{ data.issue.result.0.half_frozen|future_date(db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.verification_time)|nicedate(timeago=False) }}
        ({{ data.issue.result.0.half_frozen|future_date(db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.verification_time)|mynicedate }})</strong>
      </li>
      {% endif %}
      {% endif %}

      {% if data.issue.result.0.fully_frozen %}
      <li>Beginn der Abstimmung: {{ data.issue.result.0.fully_frozen|nicedate(timeago=False) }}</li>
      {% if not data.issue.result.0.closed %}
      <li>
        <strong>Ende der Abstimmung: {{ data.issue.result.0.fully_frozen|future_date(db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.voting_time)|nicedate(timeago=False) }}
          ({{ data.issue.result.0.fully_frozen|future_date(db_load('/policy', q={'policy_id': data.issue.result.0.policy_id}).result.0.voting_time)|mynicedate }})</strong>
      </li>
      {% endif %}
      {% endif %}

      {% if data.issue.result.0.closed %}
      <li>geschlossen: {{ data.issue.result.0.closed|nicedate(timeago=False) }}</li>
      {% endif %}
    </ul>


    {% if session.current_access_level == 'member' %}
    <h2>Interessenten</h2>

    {% if data.interest.latest.result %}
    <h3>Aktuell</h3>
    <ul class="unstyled">
    {% for p in data.interest.latest.result|sort(attribute='weight', reverse=True) %}
    <li>
      {{ p.member_id|member(True)|safe }}
      {% if p.weight > 1 %}
      {{ (p.weight-1)|delegation|safe }}
      {% endif %}
    </li>
    {% endfor %}
    </ul>
    {% endif %}

    {% if data.interest.end_of_admission.result %}
    <h3>am Ende der Neuphase</h3>
    <ul class="unstyled">
    {% for p in data.interest.end_of_admission.result|sort(attribute='weight', reverse=True) %}
    <li>
      {{ p.member_id|member(True)|safe }}
      {% if p.weight > 1 %}
      {{ (p.weight-1)|delegation|safe }}
      {% endif %}
    </li>
    {% endfor %}
    </ul>
    {% endif %}

    {% if data.interest.half_freeze.result %}
    <h3>am Ende der Diskussion</h3>
    <ul class="unstyled">
    {% for p in data.interest.half_freeze.result|sort(attribute='weight', reverse=True) %}
    <li>
      {{ p.member_id|member(True)|safe }}
      {% if p.weight > 1 %}
      {{ (p.weight-1)|delegation|safe }}
      {% endif %}
    </li>
    {% endfor %}
    </ul>
    {% endif %}

    {% if data.interest.full_freeze.result %}
    <h3>zu Beginn der Abstimmung</h3>
    <ul class="unstyled">
    {% for p in data.interest.full_freeze.result|sort(attribute='weight', reverse=True) %}
    <li>
      {{ p.member_id|member(True)|safe }}
      {% if p.weight > 1 %}
      {{ (p.weight-1)|delegation|safe }}
      {% endif %}
    </li>
    {% endfor %}
    </ul>
    {% endif %}


    {% endif %}

{% endblock %}
